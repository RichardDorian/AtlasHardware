# Database

Here's a quick overview of the database system we use for the project.

## Software

We use MySQL. Being what is promoted by the school we didn't have much of a choice. It's a good system, though.

### MySQL configuration

For testing purposes we put `.sql` files that we can import in the database. Those files are sometimes huges (due to image uploads). This can be a problem because by default the maximum packet size of MySQL is 1MB. We can change this to something more appropriate, like `16M` in order to fix potential errors.

`my.ini`

```ini
max_allowed_packet=16M
```

## Tables

### ERD (MCD)

<!--
https://www.mocodo.net/?mcd=eNpNjjEOwjAMRXefwgfI0K5dK3UDVUiIObSWiGjiyknL9XESCiyW_e33kpu4RAabE14jicG2xZ69p5AgBx262eCmXbBe71Yb44tFM7vbZAXG7b64-CjgyDGp6lxUAB9PVUx1MDjbRMeKZuRQiIr-PZ6DSmZAK8VJ3JocB4ALrYtTOHGB-8Pd_PgOBpan3gzCvmy-v8sNvAEsak94
-->

![ERD](./ERD.svg)

### MRD

#### Users

| Field             | Type          | Description                                                                                 |
| ----------------- | ------------- | ------------------------------------------------------------------------------------------- |
| <ins>**id**</ins> | `BINARY(16)`  | A unique identifier for the user. Generated by the server on sign up.                       |
| username          | `VARCHAR(20)` | The username of the user. Has a maximum length of 20 characters.                            |
| password          | `VARCHAR(60)` | The password of the user. Encrypted with bcrypt.                                            |
| avatar            | `LONGBLOB`    | The avatar of the user. Can be null (and is by default) if the user doesn't have an avatar. |

#### Posts

| Field             | Type         | Description                                                                    |
| ----------------- | ------------ | ------------------------------------------------------------------------------ |
| <ins>**id**</ins> | `BINARY(16)` | A unique identifier for the post. Generated by the server on post creation.    |
| date              | `DATETIME`   | The date and time the post was created.                                        |
| description       | `TEXT`       | The description of the post.                                                   |
| #author           | `BINARY(16)` | The unique identifier of the user that created the post.                       |
| #forked_from      | `BINARY(16)` | Identifier of the post this post was forked from. Is null if it is not a fork. |

#### Comments

| Field             | Type         | Description                                                                                   |
| ----------------- | ------------ | --------------------------------------------------------------------------------------------- |
| <ins>**id**</ins> | `BINARY(16)` | A unique identifier for the comment. Generated by the server on comment creation.             |
| #author           | `BINARY(16)` | The unique identifier of the user that created the comment.                                   |
| #post             | `BINARY(16)` | The unique identifier of the post the comment is on.                                          |
| #replied_to       | `BINARY(16)` | The unique identifier of the comment this comment is a reply to. Is null if it is not a reply |
| date              | `DATETIME`   | The date and time the comment was created.                                                    |
| comment           | `TEXT`       | The content of the comment.                                                                   |

#### Images

| Field             | Type         | Description                                                                     |
| ----------------- | ------------ | ------------------------------------------------------------------------------- |
| <ins>**id**</ins> | `BINARY(16)` | A unique identifier for the image. Generated by the server on comment creation. |
| #image            | `LONGBLOB`   | The content of the image.                                                       |

#### Users_saved_posts

| Field             | Type         | Description                                                                                       |
| ----------------- | ------------ | ------------------------------------------------------------------------------------------------- |
| <ins>**id**</ins> | `BINARY(16)` | A unique identifier for the image saved by the user. Generated by the server on comment creation. |
| #post             | `LONGBLOB`   | The unique identifier of the post, which is saved by the user.                                    |

#### Post_images

| Field               | Type         | Description                                                                    |
| ------------------- | ------------ | ------------------------------------------------------------------------------ |
| <ins>**post**</ins> | `BINARY(16)` | A unique identifier for the post. Generated by the server on comment creation. |
| #image              | `LONGBLOB`   | The content of the image, which is posted.                                     |

## Setup

In order to set up the database, you first need to set the proper environment variables. They can be modified in the `.htaccess` file. You must set a secure `ADMIN_KEY`. This key is required everytime you want to make a change to the database. Also make sure to set the host, username, password and database name. If there's no password (in the case of a local server), you can comment the line using a `#`.

When this is done, you can open `/admin/database/setup`, enter the admin key and click on `Setup database`. This will create the database and the tables.

> [!WARNING]  
> If there's already a database with the same name, it will be dropped and replaced by a new one. Make sure to backup your data if needed before doing this.
